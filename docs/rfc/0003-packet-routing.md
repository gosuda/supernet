# RFC-0003: 패킷 라우팅 명세서

## 1. 소개
### 1.1. 설계 원칙
- 패킷 스위칭 기반 라우팅 코어
- 레이턴시 인식 경로 선택
- 동적 부하 분산
- 다중 경로 장애 조치 지원

## 2. 패킷 형식
### 2.1. 프로토콜 버퍼 스키마
```protobuf
message RoutingPacket {
  PacketHeader header = 1;
  bytes payload = 2;  // ECIES 암호화 데이터

  message PacketHeader {
    bytes dest_peer = 1;    // 목적지 공개키 해시
    uint32 ttl = 2;         // 최대 홉 수 (Time-to-live)
    uint64 flow_id = 3;     // QoS 흐름 식별자
    bytes signature = 4;    // Ed25519 서명
    repeated bytes path = 5; // 선택된 노드 경로
  }
}
```

## 3. 라우팅 알고리즘
### 3.1. 핵심 구성 요소
- **레이턴시 모니터**: 실시간 RTT 측정
- **부하 평가기**: 노드 자원 사용량 메트릭
- **경로 관리자**: 다중 경로 유지 관리

### 3.2. 라우팅 결정 프로세스
```mermaid
graph LR
    A[수신 패킷] --> B{로컬 목적지?}
    B -->|예| C[애플리케이션 전달]
    B -->|아니오| D[최적 경로 선택]
    D --> E[다음 홉으로 전송]
```

### 3.3. 경로 점수 계산 공식
```
점수 = (1 / 레이턴시_ms) * (1 / CPU_사용률) * (사용가능_대역폭_Mbps / 100)
```

## 4. 라우팅 운영
### 4.1. 경로 탐색
- 30초 간격 사전 경로 탐색
- 수요 기반 반응적 경로 탐색
- 피어 조회를 위한 Kademlia DHT

### 4.2. 장애 처리
- 타임아웃 시 자동 경로 재선택
- 불안정 노드 블랙리스트 (5분 내 3회 실패)
- TTL 기반 루프 방지

## 5. 부하 분산
### 5.1. 트래픽 분배
- 노드 점수 기반 가중치 라운드 로빈
- 상태 유지 프로토콜을 위한 흐름 선호도
- 버스트 트래픽 평활화

## 6. 구현 예제
```go
func 최적경로선택(패킷 *pb.RoutingPacket) *Route {
    최고경로 := &Route{}
    최고점수 := 0.0

    for _, 경로 := range 가능한경로들 {
        점수 := (1 / 경로.평균레이턴시) * 
               (1 / 경로.노드부하) * 
               (경로.사용가능대역폭 / 100)
        
        if 점수 > 최고점수 {
            최고점수 = 점수
            최고경로 = 경로
        }
    }
    return 최고경로
}

// 한국어 주석 추가
// 가중치 계산: 레이턴시, 부하, 대역폭 고려
// 최고 점수 경로 선택
```

## 7. 보안 고려사항
- 홉별 세션 키 암호화
- 서명 체인을 통한 경로 검증
- DDoS 방지를 위한 속도 제한
- 패킷 위변조 방지 메커니즘

## 8. 성능 모니터링
- 실시간 라우팅 메트릭 대시보드
- 패킷 손실률 추적 시스템
- 자동 규모 조정 메커니즘
